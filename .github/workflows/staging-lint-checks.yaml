name: Staging Lint Checks

on:
  pull_request:
    types: [opened, edited, synchronize, labeled, unlabeled]

env:
  SPEC_REPO: Azure/azure-rest-api-specs
  SPEC_CHECKOUT_PATH: specs
  FAIL_ON_ERRORS: "false" # Set to "true" to fail the job when error findings appear
  MAX_FILES: "100"
  ALLOWED_RPS: "network,compute,monitor,sql,hdinsight,resource,storage"

jobs:
  run-selected-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout validator repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          
      - name: Checkout full specs repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SPEC_REPO }}
          path: ${{ env.SPEC_CHECKOUT_PATH }}
          fetch-depth: 0

      - name: Install Rush & dependencies
        run: |
          node common/scripts/install-run-rush.js install

      - name: Build validator (local changes)
        run: |
          node common/scripts/install-run-rush.js build -t @microsoft.azure/openapi-validator

      - name: Extract rules and run AutoRest validation
        uses: actions/github-script@v7
        with:
          script: |
            const { runInGitHubActions } = await import('${{ github.workspace }}/.github/workflows/src/extract-rule-names-and-run-validation.js');
            await runInGitHubActions(context, core, process.env);

      - name: Upload findings artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linter-findings
          path: artifacts/linter-findings.txt
          if-no-files-found: warn
