name: Staging Lint Checks

on:
  pull_request:
    types: [opened, edited, synchronize, labeled, unlabeled]

env:
  SPEC_REPO: Azure/azure-rest-api-specs
  SPEC_CHECKOUT_PATH: specs
  FAIL_ON_ERRORS: "false" # Set to "true" to fail the job when error findings appear
  # The runner script expects MAX_FILES (not MAX_READMES) â€“ increase cap as desired
  MAX_FILES: "50"
  # Allow requiring monorepo-built packages without separate npm install in scripts dir
  NODE_PATH: ${{ github.workspace }}/packages/rulesets:${{ github.workspace }}/packages/rulesets/dist

jobs:
  run-selected-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout validator repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # No separate npm install in .github/scripts to avoid needing a package-lock commit; we load built package via NODE_PATH

      - name: Determine rule names (labels first, fallback to body)
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.pull_request?.labels || []).map(l => l.name || "");
            const body = context.payload.pull_request?.body || "";

            // From labels: expect labels like test-<RuleName>
            const fromLabels = labels
              .filter(n => /^test-/i.test(n))
              .map(n => n.replace(/^test-/i, "").trim())
              .filter(Boolean);

            // From body: parse a line like "rules: A, B" (case-insensitive)
            const ruleLine = (body.match(/^\s*rules?\s*:(.*)$/gim) || [])
              .map(l => l.split(":")[1] || "")
              .join(",");

            const fromRuleLine = ruleLine
              .split(/[\n,]/)
              .map(s => s.trim())
              .filter(Boolean);

            // Prefer label selection when available; otherwise use body
            const chosen = (fromLabels.length > 0) ? fromLabels : fromRuleLine;
            const all = Array.from(new Set(chosen));
            const value = all.join(',');
            core.exportVariable('RULE_NAMES', value);
            core.info(`Selected rules: ${value || "<none>"}`);

      - name: Checkout specs repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SPEC_REPO }}
          path: ${{ env.SPEC_CHECKOUT_PATH }}

      - name: Install Rush & dependencies
        run: |
          node common/scripts/install-run-rush.js install

      - name: Build validator (local changes)
        run: |
          node common/scripts/install-run-rush.js build -t @microsoft.azure/openapi-validator

      - name: Install AutoRest
        run: |
          npm install --no-fund --no-audit autorest@latest

      - name: Run selected rules via AutoRest
        env:
          RULE_NAMES: ${{ env.RULE_NAMES }}
          SPEC_ROOT: ${{ github.workspace }}/${{ env.SPEC_CHECKOUT_PATH }}
          FAIL_ON_ERRORS: ${{ env.FAIL_ON_ERRORS }}
          MAX_FILES: ${{ env.MAX_FILES }}
          OUTPUT_FILE: ${{ github.workspace }}/artifacts/linter-findings.txt
        run: |
          node .github/scripts/run-autorest-selected-rules.js

      - name: Upload findings artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linter-findings
          path: artifacts/linter-findings.txt
          if-no-files-found: warn
